<script>
  const API_BASE = "https://endo10evo-production.up.railway.app";
  let indice = 0;
  const sessionId = Date.now().toString();
  sessionStorage.setItem("session_id", sessionId);

  let pendingConfirmation = false;
  let lastInterpretedAnswer = '';
  let firstUserInputDone = false;

  async function fetchPergunta() {
    addTypingIndicator();
    const response = await fetch(API_BASE + "/perguntar/", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: `indice=${indice}`
    });
    const data = await response.json();
    removeTypingIndicator();

    if (data.mensagem) {
      addMessage(data.mensagem, "bot");

      addTypingIndicator();
      const responseDiagnostico = await fetch(API_BASE + "/diagnostico/", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `session_id=${sessionId}`
      });
      const diagnosticoData = await responseDiagnostico.json();
      removeTypingIndicator();

      if (diagnosticoData.diagnostico) {
        addMessage(`🦷 Diagnóstico: ${diagnosticoData.diagnostico}`, "bot");
        addMessage(`📚 Diagnóstico Complementar: ${diagnosticoData.diagnostico_complementar}`, "bot");

        addTypingIndicator();
        const explicacaoResponse = await fetch(API_BASE + "/explicacao/", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `diagnostico=${encodeURIComponent(diagnosticoData.diagnostico)}&diagnostico_complementar=${encodeURIComponent(diagnosticoData.diagnostico_complementar)}`
        });
        const explicacaoData = await explicacaoResponse.json();
        removeTypingIndicator();

        addMessage(`📝 Explicação: ${explicacaoData.explicacao}`, "bot");
      } else {
        addMessage("Não consegui encontrar um diagnóstico com essas informações.", "bot");
      }
    } else {
      addMessage(data.pergunta, "bot");
    }
  }

  document.getElementById("chat-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const userInput = document.getElementById("user-input");
    const userMessage = userInput.value.trim();
    if (!userMessage) return;

    addMessage(userMessage, "user");

    if (!firstUserInputDone) {
      firstUserInputDone = true;
      await fetchPergunta();
    } else if (!pendingConfirmation) {
      addTypingIndicator();
      const response = await fetch(API_BASE + "/responder/", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `indice=${indice}&resposta_usuario=${encodeURIComponent(userMessage)}&session_id=${sessionId}`
      });
      const data = await response.json();
      removeTypingIndicator();

      lastInterpretedAnswer = data.resposta_interpretada;
      pendingConfirmation = true;

      addMessage(`Baseado na sua resposta, posso considerar **${lastInterpretedAnswer}**? (Digite: Sim ou Não)`, "bot");
    } else {
      if (userMessage.toLowerCase() === "sim") {
        await fetch(API_BASE + "/confirmar/", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `indice=${indice}&resposta_interpretada=${encodeURIComponent(lastInterpretedAnswer)}&session_id=${sessionId}`
        });

        indice += 1;
        pendingConfirmation = false;
        await fetchPergunta();
      } else {
        pendingConfirmation = false;
        await fetchPergunta();
      }
    }

    userInput.value = "";
  });

  document.getElementById("download-btn").addEventListener("click", () => {
    const sessionId = sessionStorage.getItem("session_id");
    window.open(API_BASE + `/pdf/${sessionId}`, "_blank");
  });

  async function iniciarChat() {
    addMessage("Hello! ¡Hola! Bonjour! 你好! Hallo! Ciao! Olá! नमस्ते! مرحبا! 안녕하세요! Привет! I am Endo10 EVO, your assistant for endodontic diagnosis. Please start by greeting me in your preferred language, and we will continue our conversation in that language. ✅", "bot");
  }

  iniciarChat();
</script>
