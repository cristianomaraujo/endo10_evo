<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Endo10 EVO - DiagnÃ³stico EndodÃ´ntico</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div id="chat-container">
        <div id="messages"></div>
        <form id="chat-form">
            <input type="text" id="user-input" placeholder="Digite sua resposta..." autocomplete="off" />
            <button type="submit">Enviar</button>
        </form>
        <button id="download-btn">ğŸ“„ Baixar PDF</button>
    </div>

    <script>
        const API_BASE = "https://endo10evo-production.up.railway.app";
        let indice = 0;
        const sessionId = Date.now().toString();
        sessionStorage.setItem("session_id", sessionId);
        let userLanguage = "en";
        let onboarding = true;
        let waitingConfirmation = false;

        function addMessage(message, sender) {
            const messagesDiv = document.getElementById("messages");
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message", sender);

            const avatar = document.createElement("img");
            avatar.src = sender === "bot" ? "/static/img/chatbot.png" : "/static/img/usuario.png";
            avatar.alt = sender === "bot" ? "Bot" : "User";
            avatar.classList.add("avatar");

            const text = document.createElement("div");
            text.classList.add("text");
            text.innerText = message;

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(text);
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showTyping() {
            const messagesDiv = document.getElementById("messages");
            const typingDiv = document.createElement("div");
            typingDiv.classList.add("message", "bot");
            typingDiv.id = "typing-indicator";

            const avatar = document.createElement("img");
            avatar.src = "/static/img/chatbot.png";
            avatar.alt = "Bot";
            avatar.classList.add("avatar");

            const dots = document.createElement("div");
            dots.classList.add("text");
            dots.innerText = "Digitando...";

            typingDiv.appendChild(avatar);
            typingDiv.appendChild(dots);
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function removeTyping() {
            const typingIndicator = document.getElementById("typing-indicator");
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function perguntar() {
            const response = await fetch(API_BASE + "/perguntar/", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `indice=${indice}&session_id=${sessionId}`
            });
            const data = await response.json();
            return data.pergunta;
        }

        async function responder(indice, resposta_usuario) {
            const response = await fetch(API_BASE + "/responder/", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `indice=${indice}&resposta_usuario=${encodeURIComponent(resposta_usuario)}&session_id=${sessionId}`
            });
            const data = await response.json();
            return data;
        }

        async function diagnostico() {
            const response = await fetch(API_BASE + "/diagnostico/", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `session_id=${sessionId}`
            });
            const data = await response.json();
            return data;
        }

        async function traduzir(texto, idioma) {
            const response = await fetch("https://libretranslate.de/translate", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    q: texto,
                    source: "en",
                    target: idioma
                })
            });
            const data = await response.json();
            return data.translatedText;
        }

        document.getElementById("chat-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const userInput = document.getElementById("user-input");
            const userMessage = userInput.value.trim();
            if (!userMessage) return;

            addMessage(userMessage, "user");

            if (onboarding) {
                userLanguage = await detectLanguage(userMessage);
                onboarding = false;

                showTyping();
                await delay(1000);
                removeTyping();

                const firstQuestion = await perguntar();
                addMessage(firstQuestion, "bot");
            } else if (waitingConfirmation) {
                if (userMessage.toLowerCase() === "sim" || userMessage.toLowerCase() === "yes") {
                    indice++;
                    showTyping();
                    await delay(1000);
                    removeTyping();

                    const proximaPergunta = await perguntar();
                    if (proximaPergunta) {
                        addMessage(proximaPergunta, "bot");
                    } else {
                        const resultado = await diagnostico();
                        if (resultado.diagnostico) {
                            addMessage(`ğŸ¦· DiagnÃ³stico: ${resultado.diagnostico}`, "bot");
                            addMessage(`ğŸ“š DiagnÃ³stico Complementar: ${resultado.diagnostico_complementar}`, "bot");

                            const explicacaoEn = "This diagnosis was based on the provided triage responses and is intended to support clinical assessment. Please consult a specialist for confirmation and appropriate treatment.";
                            const explicacaoTraduzida = await traduzir(explicacaoEn, userLanguage);
                            addMessage(explicacaoTraduzida, "bot");
                        } else {
                            addMessage("NÃ£o consegui encontrar um diagnÃ³stico com essas informaÃ§Ãµes.", "bot");
                        }
                    }
                    waitingConfirmation = false;
                } else {
                    addMessage("Por favor, digite novamente sua resposta:", "bot");
                    waitingConfirmation = false;
                }
            } else {
                showTyping();
                await delay(1000);
                const data = await responder(indice, userMessage);
                removeTyping();

                showTyping();
                await delay(1000);
                removeTyping();
                addMessage(`VocÃª quis dizer: ${data.resposta_interpretada}? (sim/nÃ£o)`, "bot");

                waitingConfirmation = true;
            }

            userInput.value = "";
        });

        async function detectLanguage(text) {
            const response = await fetch("https://libretranslate.de/detect", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ q: text })
            });
            const data = await response.json();
            return data[0]?.language || "en";
        }

        document.getElementById("download-btn").addEventListener("click", () => {
            const sessionId = sessionStorage.getItem("session_id");
            window.open(API_BASE + `/pdf/${sessionId}`, "_blank");
        });

        async function saudacaoInicial() {
            const mensagem = `Hello! ğŸ‘‹ Â¡Hola! ğŸ‘‹ OlÃ¡! ğŸ‘‹ Bonjour! ğŸ‘‹ Hallo! ğŸ‘‹ ä½ å¥½! ğŸ‘‹ ã“ã‚“ã«ã¡ã¯! ğŸ‘‹ ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§! ğŸ‘‹
I am Endo10 EVO, your assistant for endodontic diagnosis ğŸ¦·âœ¨.
You can reply in your preferred language ğŸŒ.
Shall we begin your triage? âœ…`;

            addMessage(mensagem, "bot");
        }

        saudacaoInicial();
    </script>
</body>
</html>
