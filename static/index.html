<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Endo10 EVO - Endodontic Diagnosis</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div id="chat-container">
        <div id="messages"></div>
        <form id="chat-form">
            <input type="text" id="user-input" placeholder="Type your response..." autocomplete="off" />
            <button type="submit">Send</button>
        </form>
        <button id="download-btn" style="display:none;">📄 Download PDF</button>
    </div>

    <script>
        const API_BASE = "https://endo10evo-production.up.railway.app";
        let indice = 0;
        const sessionId = Date.now().toString();
        sessionStorage.setItem("session_id", sessionId);
        let idiomaDetectado = false;
        let aguardandoConfirmacao = false;
        let respostaIntermediaria = "";

        function addMessage(message, sender) {
            const messagesDiv = document.getElementById("messages");
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message", sender);

            const avatar = document.createElement("img");
            avatar.src = sender === "bot" ? "/static/img/chatbot.png" : "/static/img/usuario.png";
            avatar.alt = sender === "bot" ? "Bot" : "User";
            avatar.classList.add("avatar");

            const text = document.createElement("div");
            text.classList.add("text");
            text.innerText = message;

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(text);
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function enviarIdioma(userMessage) {
            const response = await fetch(API_BASE + "/detectar_idioma/", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `idioma_usuario=${encodeURIComponent(userMessage)}&session_id=${sessionId}`
            });
            await response.json();
            idiomaDetectado = true;
            await perguntar();
        }

        async function perguntar() {
            const response = await fetch(API_BASE + "/perguntar/", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `indice=${indice}&session_id=${sessionId}`
            });
            const data = await response.json();
            if (data.pergunta) {
                addMessage(data.pergunta, "bot");
            } else if (data.mensagem) {
                addMessage(data.mensagem, "bot");

                // Diagnóstico final
                const responseDiagnostico = await fetch(API_BASE + "/diagnostico/", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: `session_id=${sessionId}`
                });
                const diagnosticoData = await responseDiagnostico.json();
                if (diagnosticoData.diagnostico) {
                    addMessage(`🦷 Diagnóstico: ${diagnosticoData.diagnostico}`, "bot");
                    addMessage(`📚 Diagnóstico Complementar: ${diagnosticoData.diagnostico_complementar}`, "bot");
                    addMessage(`ℹ️ Explicação: ${diagnosticoData.explicacao}`, "bot");
                } else {
                    addMessage("Não consegui encontrar um diagnóstico com essas informações.", "bot");
                }
                document.getElementById("download-btn").style.display = "block";
            }
        }

        async function responder(userMessage) {
            const response = await fetch(API_BASE + "/responder/", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `indice=${indice}&resposta_usuario=${encodeURIComponent(userMessage)}&session_id=${sessionId}`
            });
            const data = await response.json();

            // Pergunta confirmação
            respostaIntermediaria = data.resposta_interpretada;
            aguardandoConfirmacao = true;
            addMessage(`Posso considerar que a resposta é: "${respostaIntermediaria}"? (Sim/Não)`, "bot");
        }

        document.getElementById("chat-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const userInput = document.getElementById("user-input");
            const userMessage = userInput.value.trim();
            if (!userMessage) return;

            addMessage(userMessage, "user");

            if (!idiomaDetectado) {
                await enviarIdioma(userMessage);
            } else if (aguardandoConfirmacao) {
                if (userMessage.toLowerCase() === "sim" || userMessage.toLowerCase() === "yes") {
                    indice++;
                    aguardandoConfirmacao = false;
                    await perguntar();
                } else {
                    aguardandoConfirmacao = false;
                    addMessage("Ok, por favor responda novamente.", "bot");
                }
            } else {
                await responder(userMessage);
            }

            userInput.value = "";
        });

        document.getElementById("download-btn").addEventListener("click", () => {
            window.open(API_BASE + `/pdf/${sessionId}`, "_blank");
        });

        // Saudação inicial
        addMessage(`Hello! 👋 ¡Hola! 👋 Olá! 👋 Bonjour! 👋 Hallo! 👋 你好! 👋 こんにちは! 👋 안녕하세요! 👋 مرحبا! 👋
I am Endo10 EVO, your assistant for endodontic diagnosis 🦷✨.
You can reply in your preferred language 🌍.
Shall we begin your triage? ✅`, "bot");

    </script>
</body>
</html>
