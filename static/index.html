<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Endo10 EVO - Diagnóstico Endodôntico</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div id="chat-container">
    <div id="messages"></div>
    <form id="chat-form">
        <input type="text" id="user-input" placeholder="Digite sua resposta..." autocomplete="off" />
        <button type="submit">Enviar</button>
    </form>
    <button id="download-btn">📄 Baixar PDF</button>
</div>

<script>
    const API_BASE = "https://endo10evo-production.up.railway.app";
    const sessionId = Date.now().toString();
    sessionStorage.setItem("session_id", sessionId);
    let languageSet = false;
    let indice = 0;

    function addMessage(message, sender) {
        const messagesDiv = document.getElementById("messages");
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message", sender);

        const avatar = document.createElement("img");
        avatar.src = sender === "bot" ? "/static/img/chatbot.png" : "/static/img/usuario.png";
        avatar.alt = sender;
        avatar.classList.add("avatar");

        const text = document.createElement("div");
        text.classList.add("text");
        text.innerText = message;

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(text);
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function startChat() {
        const welcome = `Hello! 👋 ¡Hola! 👋 Olá! 👋 Bonjour! 👋 Hallo! 👋 你好! 👋 こんにちは! 👋 안녕하세요! 👋 !مرحبا 👋
I am Endo10 EVO, your assistant for endodontic diagnosis 🦷✨.
You can reply in your preferred language 🌍.
Shall we begin your triage? ✅`;
        addMessage(welcome, "bot");
    }

    document.getElementById("chat-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const userInput = document.getElementById("user-input");
        const userMessage = userInput.value.trim();
        if (!userMessage) return;

        addMessage(userMessage, "user");

        if (!languageSet) {
            const response = await fetch(API_BASE + "/set_language/", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `user_input=${encodeURIComponent(userMessage)}&session_id=${sessionId}`
            });
            const data = await response.json();
            if (data.error) {
                addMessage(data.error, "bot");
                return;
            }
            languageSet = true;
            nextQuestion();
        } else {
            const response = await fetch(API_BASE + "/responder/", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: `resposta_usuario=${encodeURIComponent(userMessage)}&session_id=${sessionId}`
            });
            const data = await response.json();
            nextQuestion();
        }

        userInput.value = "";
    });

    async function nextQuestion() {
        const response = await fetch(API_BASE + "/perguntar/", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `session_id=${sessionId}`
        });
        const data = await response.json();

        if (data.pergunta) {
            addMessage(data.pergunta, "bot");
        } else if (data.mensagem) {
            addMessage(data.mensagem, "bot");
            getDiagnostico();
        }
    }

    async function getDiagnostico() {
        const response = await fetch(API_BASE + "/diagnostico/", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `session_id=${sessionId}`
        });
        const data = await response.json();
        if (data.diagnostico) {
            addMessage(`🦷 Diagnóstico: ${data.diagnostico}`, "bot");
            addMessage(`📚 Diagnóstico Complementar: ${data.diagnostico_complementar}`, "bot");
        } else {
            addMessage("Não consegui encontrar um diagnóstico com essas informações.", "bot");
        }
    }

    document.getElementById("download-btn").addEventListener("click", () => {
        window.open(API_BASE + `/pdf/${sessionId}`, "_blank");
    });

    startChat();
</script>
</body>
</html>
