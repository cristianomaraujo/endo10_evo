<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Endo10 EVO - DiagnÃ³stico EndodÃ´ntico</title>
    <link rel="stylesheet" href="https://endo10evo-production.up.railway.app/static/style.css">
</head>
<body>
    <div id="chat-container">
        <div id="messages"></div>
        <form id="chat-form">
            <input type="text" id="user-input" placeholder="Digite sua resposta..." autocomplete="off" />
            <button type="submit">Enviar</button>
        </form>
        <button id="download-btn">ðŸ“„ Baixar PDF</button>
    </div>

    <script>
        const API_BASE = "https://endo10evo-production.up.railway.app";
        let indice = 0;
        let sessionId = Date.now().toString();
        let idiomaDetectado = "";

        sessionStorage.setItem("session_id", sessionId);

        function addMessage(message, sender) {
            const messagesDiv = document.getElementById("messages");
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message", sender);

            const avatar = document.createElement("img");
            avatar.src = sender === "bot" ? "/static/img/chatbot.png" : "/static/img/usuario.png";
            avatar.alt = sender === "bot" ? "Bot" : "User";
            avatar.classList.add("avatar");

            const text = document.createElement("div");
            text.classList.add("text");
            text.innerText = message;

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(text);
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function loadingDots() {
            const messagesDiv = document.getElementById("messages");
            const loadingDiv = document.createElement("div");
            loadingDiv.classList.add("message", "bot");
            loadingDiv.setAttribute("id", "loading");
            const avatar = document.createElement("img");
            avatar.src = "/static/img/chatbot.png";
            avatar.alt = "Bot";
            avatar.classList.add("avatar");

            const text = document.createElement("div");
            text.classList.add("text");
            text.innerText = "...";
            loadingDiv.appendChild(avatar);
            loadingDiv.appendChild(text);
            messagesDiv.appendChild(loadingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function removeLoadingDots() {
            const loadingDiv = document.getElementById("loading");
            if (loadingDiv) loadingDiv.remove();
        }

        async function iniciarChat() {
            const welcomeMessage = "Hello | OlÃ¡ | Hola | Bonjour | Hallo | Ciao | ã“ã‚“ã«ã¡ã¯ | ä½ å¥½ | ÐŸÑ€Ð¸Ð²ÐµÑ‚! ðŸ‘‹\n\nPlease say 'hello' in your native language to start.";
            addMessage(welcomeMessage, "bot");
        }

        document.getElementById("chat-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const userInput = document.getElementById("user-input");
            const userMessage = userInput.value.trim();
            if (!userMessage) return;

            addMessage(userMessage, "user");

            if (!idiomaDetectado) {
                loadingDots();
                const detectResponse = await fetch(API_BASE + "/detectar/", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: `texto=${encodeURIComponent(userMessage)}`
                });
                const detectData = await detectResponse.json();
                idiomaDetectado = detectData.idioma || "en";
                removeLoadingDots();

                loadingDots();
                const response = await fetch(API_BASE + "/perguntar/", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: `indice=${indice}`
                });
                const data = await response.json();
                removeLoadingDots();
                addMessage(data.pergunta, "bot");
            } else {
                loadingDots();
                const response = await fetch(API_BASE + "/responder/", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: `indice=${indice}&resposta_usuario=${encodeURIComponent(userMessage)}&session_id=${sessionId}&idioma=${idiomaDetectado}`
                });
                const data = await response.json();
                removeLoadingDots();

                indice += 1;

                loadingDots();
                const proximaPergunta = await fetch(API_BASE + "/perguntar/", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: `indice=${indice}`
                });
                const perguntaData = await proximaPergunta.json();
                removeLoadingDots();

                if (perguntaData.mensagem) {
                    addMessage(perguntaData.mensagem, "bot");

                    loadingDots();
                    const responseDiagnostico = await fetch(API_BASE + "/diagnostico/", {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: `session_id=${sessionId}`
                    });
                    const diagnosticoData = await responseDiagnostico.json();
                    removeLoadingDots();

                    if (diagnosticoData.diagnostico) {
                        addMessage(`ðŸ¦· DiagnÃ³stico: ${diagnosticoData.diagnostico}`, "bot");
                        addMessage(`ðŸ“š DiagnÃ³stico Complementar: ${diagnosticoData.diagnostico_complementar}`, "bot");
                        addMessage(`ðŸ’¡ ExplicaÃ§Ã£o: ${diagnosticoData.explicacao}`, "bot");
                    } else {
                        addMessage("Sorry, I couldn't find a diagnosis with this information.", "bot");
                    }
                } else {
                    addMessage(perguntaData.pergunta, "bot");
                }
            }
            userInput.value = "";
        });

        document.getElementById("download-btn").addEventListener("click", () => {
            const sessionId = sessionStorage.getItem("session_id");
            window.open(API_BASE + `/pdf/${sessionId}`, "_blank");
        });

        iniciarChat();
    </script>
</body>
</html>
