<script>
  const API_BASE = "https://endo10evo-production.up.railway.app";
  let indice = 0;
  const sessionId = Date.now().toString();
  sessionStorage.setItem("session_id", sessionId);

  let pendingConfirmation = false;
  let lastInterpretedAnswer = '';
  let firstUserMessageSent = false;  // <-- NOVA FLAG para primeira mensagem

  function addMessage(message, sender) {
    const messagesDiv = document.getElementById("messages");
    const messageDiv = document.createElement("div");
    messageDiv.classList.add("message", sender);

    const avatar = document.createElement("img");
    avatar.src = sender === "bot" ? "/static/img/chatbot.png" : "/static/img/usuario.png";
    avatar.alt = sender === "bot" ? "Bot" : "User";
    avatar.classList.add("avatar");

    const text = document.createElement("div");
    text.classList.add("text");
    text.innerText = message;

    messageDiv.appendChild(avatar);
    messageDiv.appendChild(text);
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function addTypingIndicator() {
    const messagesDiv = document.getElementById("messages");
    const typingDiv = document.createElement("div");
    typingDiv.classList.add("message", "bot");
    typingDiv.setAttribute("id", "typing");

    const avatar = document.createElement("img");
    avatar.src = "/static/img/chatbot.png";
    avatar.alt = "Bot";
    avatar.classList.add("avatar");

    const text = document.createElement("div");
    text.classList.add("text");
    text.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>';

    typingDiv.appendChild(avatar);
    typingDiv.appendChild(text);
    messagesDiv.appendChild(typingDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function removeTypingIndicator() {
    const typingDiv = document.getElementById("typing");
    if (typingDiv) {
      typingDiv.remove();
    }
  }

  async function fetchPergunta() {
    addTypingIndicator();
    const response = await fetch(API_BASE + "/perguntar/", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: `indice=${indice}&session_id=${sessionId}`
    });
    const data = await response.json();
    removeTypingIndicator();

    if (data.mensagem) {
      addMessage(data.mensagem, "bot");
      // Buscar diagnóstico
      await fetchDiagnostico();
    } else {
      addMessage(data.pergunta, "bot");
    }
  }

  async function fetchDiagnostico() {
    addTypingIndicator();
    const response = await fetch(API_BASE + "/diagnostico/", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: `session_id=${sessionId}`
    });
    const diagnosticoData = await response.json();
    removeTypingIndicator();

    if (diagnosticoData.diagnostico) {
      addMessage(`🦷 Diagnóstico: ${diagnosticoData.diagnostico}`, "bot");
      addMessage(`📚 Diagnóstico Complementar: ${diagnosticoData.diagnostico_complementar}`, "bot");

      // Buscar explicação
      await fetchExplicacao(diagnosticoData.diagnostico, diagnosticoData.diagnostico_complementar);
    } else {
      addMessage("Não consegui encontrar um diagnóstico com essas informações.", "bot");
    }
  }

  async function fetchExplicacao(diagnostico, diagnostico_complementar) {
    addTypingIndicator();
    const explicacaoResponse = await fetch(API_BASE + "/explicacao/", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: `diagnostico=${encodeURIComponent(diagnostico)}&diagnostico_complementar=${encodeURIComponent(diagnostico_complementar)}`
    });
    const explicacaoData = await explicacaoResponse.json();
    removeTypingIndicator();

    addMessage(`📝 Explicação: ${explicacaoData.explicacao}`, "bot");
  }

  document.getElementById("chat-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const userInput = document.getElementById("user-input");
    const userMessage = userInput.value.trim();
    if (!userMessage) return;

    addMessage(userMessage, "user");

    if (!firstUserMessageSent) {
      addTypingIndicator();
      const response = await fetch(API_BASE + "/responder/", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `indice=${indice}&resposta_usuario=${encodeURIComponent(userMessage)}&session_id=${sessionId}`
      });
      const data = await response.json();
      removeTypingIndicator();
      firstUserMessageSent = true;
      await fetchPergunta();  // <-- SOMENTE AGORA CHAMA
    } else if (!pendingConfirmation) {
      addTypingIndicator();
      const response = await fetch(API_BASE + "/responder/", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `indice=${indice}&resposta_usuario=${encodeURIComponent(userMessage)}&session_id=${sessionId}`
      });
      const data = await response.json();
      removeTypingIndicator();

      lastInterpretedAnswer = data.resposta_interpretada;
      pendingConfirmation = true;

      addMessage(`Baseado na sua resposta, posso considerar **${lastInterpretedAnswer}**? (Digite: Sim ou Não)`, "bot");
    } else {
      if (userMessage.toLowerCase() === "sim") {
        await fetch(API_BASE + "/confirmar/", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `indice=${indice}&resposta_interpretada=${encodeURIComponent(lastInterpretedAnswer)}&session_id=${sessionId}`
        });

        indice += 1;
        pendingConfirmation = false;
        await fetchPergunta();
      } else {
        pendingConfirmation = false;
        await fetchPergunta();
      }
    }

    userInput.value = "";
  });

  document.getElementById("download-btn").addEventListener("click", () => {
    const sessionId = sessionStorage.getItem("session_id");
    window.open(API_BASE + `/pdf/${sessionId}`, "_blank");
  });

  // Iniciar chat só com saudação inicial
  addMessage("Hello! ¡Hola! Bonjour! 你好! Hallo! Ciao! Olá! नमस्ते! مرحبا! 안녕하세요! Привет!\n\nI am Endo10 EVO, your assistant for endodontic diagnosis. Please greet me in your preferred language. 🌍", "bot");
</script>
